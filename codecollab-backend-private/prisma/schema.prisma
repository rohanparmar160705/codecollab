///////////////////////////////////////////////////////////////
// üåê DATABASE + GENERATOR
///////////////////////////////////////////////////////////////

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

///////////////////////////////////////////////////////////////
// üë§ USER + AUTHENTICATION
///////////////////////////////////////////////////////////////

model User {
  id            String   @id @default(cuid())
  username      String   @unique
  email         String   @unique
  passwordHash  String?
  avatarUrl     String?
  role          String   @default("Developer")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // ‚úÖ Relationships
  sessions      Session[]
  roomsCreated  Room[]       @relation("RoomOwner")
  memberships   RoomMember[]
  messages      Message[]
  executions    Execution[]
}

model Session {
  id           String   @id @default(cuid())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  refreshToken String   @unique
  createdAt    DateTime @default(now())
  expiresAt    DateTime
}

///////////////////////////////////////////////////////////////
// üí¨ COLLAB ROOMS
///////////////////////////////////////////////////////////////

model Room {
  id             String    @id @default(cuid())
  name           String
  description    String?
  owner          User      @relation("RoomOwner", fields: [ownerId], references: [id])
  ownerId        String
  language       String
  isPublic       Boolean   @default(false)
  lastKnownCode  String?   @default("")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  lastKnownInput String?   @default("")
  lastKnownOutput String?  @default("")

  members        RoomMember[]
  messages       Message[]
  executions     Execution[]
}

model RoomMember {
  id       String   @id @default(cuid())
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   String
  room     Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  roomId   String
  role     RoleType @default(VIEWER)
  joinedAt DateTime @default(now())

  @@unique([userId, roomId])
}

///////////////////////////////////////////////////////////////
// üìÇ EXECUTION + MESSAGES
///////////////////////////////////////////////////////////////

model Execution {
  id           String     @id @default(cuid())
  room         Room       @relation(fields: [roomId], references: [id], onDelete: Cascade)
  roomId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  language     String
  code         String
  input        String?
  output       String?
  status       ExecStatus
  execTimeMs   Int?
  errorMessage String?
  createdAt    DateTime   @default(now())
}

///////////////////////////////////////////////////////////////
// üß± ENUMS
///////////////////////////////////////////////////////////////

enum RoleType {
  OWNER
  EDITOR
  VIEWER
}

enum ExecStatus {
  QUEUED
  RUNNING
  COMPLETED
  FAILED
  TIMEOUT
}
